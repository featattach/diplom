{% extends "base.html" %}
{% block title %}{{ asset.name }} — Система учёта оборудования{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="card-title">Карточка оборудования</h1>
    <div>
        {% if user.role.value in ['admin', 'user'] %}
        <a href="{{ request.url_for('asset_edit', asset_id=asset.id) }}" class="btn btn-primary">Внести изменения</a>
        {% endif %}
        <a href="{{ request.url_for('assets_list') }}" class="btn btn-outline-secondary">К списку</a>
    </div>
</div>
{% if is_inactive %}
<div class="alert alert-warning-custom alert">Устройство неактивно (нет недавней активности).</div>
{% endif %}
{% if inventory_campaign %}
<div class="alert alert-info d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <span>Кампания инвентаризации: <strong>{{ inventory_campaign.name }}</strong></span>
    <a href="{{ request.url_for('inventory_detail', campaign_id=inventory_campaign.id) }}" class="btn btn-sm btn-outline-primary">К кампании</a>
</div>
{% if request.query_params.get('marked') %}
<div class="alert alert-success mb-3">Оборудование отмечено как отсканировано (найдено) в этой кампании.</div>
{% endif %}
{% if inventory_item and inventory_item.found %}
<p class="text-success mb-3"><span class="badge bg-success">Отсканировано</span> {{ inventory_item.found_at.strftime('%Y-%m-%d %H:%M') if inventory_item.found_at else '' }}</p>
{% else %}
<form method="post" action="{{ request.url_for('asset_mark_inventory_found', asset_id=asset.id) }}" class="mb-3">
    <input type="hidden" name="campaign_id" value="{{ inventory_campaign.id }}">
    <button type="submit" class="btn btn-success">Отметить как отсканировано</button>
</form>
{% endif %}
{% endif %}
<dl class="row mb-4">
    <dt class="col-sm-3">Инв. номер / ID</dt><dd class="col-sm-9">{{ asset.id }}</dd>
    <dt class="col-sm-3">Название</dt><dd class="col-sm-9">{{ asset.name }}</dd>
    <dt class="col-sm-3">Тип техники</dt><dd class="col-sm-9">{{ equipment_kind_labels.get(asset.equipment_kind, asset.equipment_kind or '—') }}</dd>
    <dt class="col-sm-3">Модель</dt><dd class="col-sm-9">{{ asset.model or '—' }}</dd>
    <dt class="col-sm-3">Серийный номер</dt><dd class="col-sm-9">{{ asset.serial_number or '—' }}</dd>
    <dt class="col-sm-3">Категория</dt><dd class="col-sm-9">{{ asset.asset_type or '—' }}</dd>
    <dt class="col-sm-3">Расположение</dt><dd class="col-sm-9">{{ asset.location or '—' }}</dd>
    <dt class="col-sm-3">Организация</dt><dd class="col-sm-9">{% if asset.company %}<a href="{{ request.url_for('company_detail', company_id=asset.company.id) }}">{{ asset.company.name }}</a>{% else %}—{% endif %}</dd>
    <dt class="col-sm-3">Статус</dt><dd class="col-sm-9"><span class="badge bg-secondary">{{ asset.status.value }}</span></dd>
    <dt class="col-sm-3">Последняя активность</dt><dd class="col-sm-9">{{ asset.last_seen_at.strftime('%Y-%m-%d %H:%M') if asset.last_seen_at else '—' }}</dd>
    {% if asset.equipment_kind == 'server' and asset.rack_units is not none %}
    <dt class="col-sm-3">Юниты (U)</dt><dd class="col-sm-9">{{ asset.rack_units }}</dd>
    {% endif %}
    {% if asset.cpu or asset.ram or asset.disk1_type or asset.disk1_capacity or asset.network_card or asset.motherboard or asset.power_supply or asset.monitor_diagonal or asset.screen_diagonal or asset.screen_resolution %}
    <dt class="col-sm-3">Процессор</dt><dd class="col-sm-9">{{ asset.cpu or '—' }}</dd>
    <dt class="col-sm-3">ОЗУ</dt><dd class="col-sm-9">{{ asset.ram or '—' }}</dd>
    <dt class="col-sm-3">Диск (тип / объём)</dt><dd class="col-sm-9">{{ (asset.disk1_type or '') + (' ' + asset.disk1_capacity if asset.disk1_capacity else '') or '—' }}</dd>
    <dt class="col-sm-3">Сетевая карта</dt><dd class="col-sm-9">{{ asset.network_card or '—' }}</dd>
    <dt class="col-sm-3">Материнская плата</dt><dd class="col-sm-9">{{ asset.motherboard or '—' }}</dd>
    <dt class="col-sm-3">Блок питания</dt><dd class="col-sm-9">{{ asset.power_supply or '—' }}</dd>
    <dt class="col-sm-3">Монитор (диагональ)</dt><dd class="col-sm-9">{{ asset.monitor_diagonal or '—' }}</dd>
    <dt class="col-sm-3">Диагональ экрана</dt><dd class="col-sm-9">{{ asset.screen_diagonal or '—' }}</dd>
    <dt class="col-sm-3">Разрешение экрана</dt><dd class="col-sm-9">{{ asset.screen_resolution or '—' }}</dd>
    {% endif %}
    {% if extra_components_list %}
    <dt class="col-sm-3">Доп. устройства</dt>
    <dd class="col-sm-9">
        <ul class="list-unstyled mb-0">
            {% for c in extra_components_list %}
            <li><span class="badge bg-light text-dark">{{ component_type_labels.get(c.type, c.type) }}</span> {{ c.name or '—' }}</li>
            {% endfor %}
        </ul>
    </dd>
    {% endif %}
    <dt class="col-sm-3">Описание</dt><dd class="col-sm-9">{{ asset.description or '—' }}</dd>
</dl>
<div class="qr-block border rounded p-3 mb-4 bg-light">
    <h3 class="h6 mb-3">QR-код для инвентаризации</h3>
    {% if qr_exists %}
    <div id="qr-print-area" class="d-flex flex-wrap align-items-center gap-3">
        <img src="{{ request.url_for('asset_qr_image', asset_id=asset.id) }}" alt="QR-код" class="qr-preview" width="160" height="160">
        <div>
            <p class="text-muted small mb-2">Сканирование откроет эту карточку на устройстве.</p>
            <form method="post" action="{{ request.url_for('asset_generate_qr', asset_id=asset.id) }}" class="d-inline me-1">
                <button type="submit" class="btn btn-outline-secondary btn-sm">Перегенерировать QR</button>
            </form>
            <button type="button" class="btn btn-outline-primary btn-sm" id="btn-print-qr"
                data-asset-name="{{ asset.name }}{% if asset.serial_number %} ({{ asset.serial_number }}){% endif %}"
                data-qr-src="{{ request.url_for('asset_qr_image', asset_id=asset.id) }}">Распечатать QR-код</button>
        </div>
    </div>
    {% else %}
    <p class="text-muted small mb-2">Сгенерируйте QR-код — его можно распечатать и наклеить на технику. При сканировании откроется эта карточка.</p>
    <form method="post" action="{{ request.url_for('asset_generate_qr', asset_id=asset.id) }}">
        <button type="submit" class="btn btn-primary">Сгенерировать QR-код</button>
    </form>
    {% endif %}
</div>
{% if user.role.value in ['admin', 'user'] %}
<h3 class="h5 mt-4">Добавить событие</h3>
<form method="post" action="{{ request.url_for('asset_add_event', asset_id=asset.id) }}" class="row g-2 mb-4">
    <div class="col-auto">
        <select name="event_type" class="form-select" required>
            {% for t in event_type_options %}
            <option value="{{ t.value }}">{{ t.label }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col">
        <input type="text" name="description" class="form-control" placeholder="Комментарий">
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-primary">Добавить</button>
    </div>
</form>
{% endif %}
<h3 class="h5 mt-4">История изменений</h3>
<div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>Дата</th>
                <th>Тип события</th>
                <th>Описание</th>
            </tr>
        </thead>
        <tbody>
            {% for e in events %}
            <tr>
                <td>{{ e.created_at.strftime('%Y-%m-%d %H:%M') if e.created_at else '—' }}</td>
                <td><span class="badge bg-info">{{ event_type_labels.get(e.event_type.value, e.event_type.value) if event_type_labels else e.event_type.value }}</span></td>
                <td>{{ e.description or '—' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="3" class="text-muted">Нет событий</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
{% block scripts %}
<script>
(function() {
    var btn = document.getElementById('btn-print-qr');
    if (!btn) return;
    btn.addEventListener('click', function() {
        var name = btn.getAttribute('data-asset-name') || '';
        var path = btn.getAttribute('data-qr-src') || '';
        var qrUrl = path.indexOf('http') === 0 ? path : (window.location.origin + path);
        var w = window.open('', '_blank', 'width=400,height=500');
        if (!w) {
            alert('Разрешите всплывающие окна для печати QR-кода.');
            return;
        }
        w.document.write(
            '<!DOCTYPE html><html><head><meta charset="utf-8"><title>QR — ' + (name.replace(/</g, '&lt;')) + '</title>' +
            '<style>body{margin:0;padding:2cm;font-family:sans-serif;text-align:center;}h1{font-size:1.1rem;margin-bottom:1rem;}img{display:block;margin:0 auto;}</style></head><body>' +
            '<h1>' + (name.replace(/</g, '&lt;')) + '</h1>' +
            '<img src="' + qrUrl.replace(/"/g, '&quot;') + '" alt="QR" width="200" height="200" onload="window.focus();window.print();window.onafterprint=function(){window.close();};">' +
            '</body></html>'
        );
        w.document.close();
    });
})();
</script>
{% endblock %}
