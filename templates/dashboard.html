{% extends "base.html" %}
{% block title %}Дашборд — Система учёта оборудования{% endblock %}
{% block content %}
<h1 class="card-title">Дашборд</h1>
<p class="card-subtitle">Сводка по оборудованию</p>

{% if alert_lines %}
<div class="alert alert-warning d-flex align-items-start mb-4" role="alert">
  <span class="text-danger me-2" style="font-size: 1.2rem;">●</span>
  <div>
    <strong>События, требующие внимания:</strong>
    <ul class="mb-0 mt-1">
      {% for line in alert_lines %}
      <li>{{ line }}</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endif %}

<div class="row g-2 mb-3">
  <div class="col-6 col-md-3">
    <div class="card h-100 dashboard-stat-card">
      <div class="card-body py-2 px-3 d-flex flex-column">
        <div class="text-muted small">Всего устройств</div>
        <div class="fs-4 fw-bold">{{ total_devices }}</div>
        <a href="{{ request.url_for('assets_list') }}" class="btn btn-primary btn-sm mt-auto align-self-start py-1">Перейти</a>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card h-100 dashboard-stat-card">
      <div class="card-body py-2 px-3 d-flex flex-column">
        <div class="text-muted small">Активных</div>
        <div class="fs-4 fw-bold text-success">{{ active_count }}</div>
        <a href="{{ request.url_for('assets_list') }}?status=active" class="btn btn-outline-success btn-sm mt-auto align-self-start py-1">Перейти</a>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card h-100 dashboard-stat-card">
      <div class="card-body py-2 px-3 d-flex flex-column">
        <div class="text-muted small">Неактивных</div>
        <div class="fs-4 fw-bold text-danger">{{ inactive_count }}</div>
        <a href="{{ request.url_for('assets_list') }}?inactive_by_activity=1" class="btn btn-outline-danger btn-sm mt-auto align-self-start py-1">Перейти</a>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card h-100 dashboard-stat-card">
      <div class="card-body py-2 px-3 d-flex flex-column">
        <div class="text-muted small">Списано</div>
        <div class="fs-4 fw-bold text-warning">{{ retired_count }}</div>
        <a href="{{ request.url_for('assets_list') }}?status=retired" class="btn btn-outline-secondary btn-sm mt-auto align-self-start py-1">Перейти</a>
      </div>
    </div>
  </div>
</div>

<div class="row g-2 mb-3">
  <div class="col-md-6">
    <div class="card h-100 dashboard-chart-card">
      <div class="card-header bg-light py-2 small">Распределение по статусу</div>
      <div class="card-body py-2 px-3 chart-wrap">
        <canvas id="chartStatus"></canvas>
        <div class="small text-muted mt-1">
          <span class="me-2">Активные – {{ chart_status.active }}%</span>
          <span class="me-2">Неактивные – {{ chart_status.inactive }}%</span>
          <span>Списано – {{ chart_status.retired }}%</span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card h-100 dashboard-chart-card">
      <div class="card-header bg-light py-2 small">Неактивность по времени</div>
      <div class="card-body py-2 px-3 chart-wrap">
        <canvas id="chartInactivity"></canvas>
        <div class="small text-muted mt-1">
          <span class="me-2">До 7 дней – {{ chart_inactivity['0_7'] }}%</span>
          <span class="me-2">Неделя–месяц – {{ chart_inactivity['7_30'] }}%</span>
          <span>Более месяца – {{ chart_inactivity['30_plus'] }}%</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center small">
    <span>Устройства, требующие внимания</span>
    <a href="{{ request.url_for('assets_list') }}" class="btn btn-primary btn-sm py-1">К списку</a>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead>
          <tr>
            <th>Имя</th>
            <th>Расположение</th>
            <th>Событие</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for item in devices_requiring_attention %}
          <tr class="{% if item.event_type == 'inactive' %}table-warning{% endif %}">
            <td><a href="{{ request.url_for('asset_detail', asset_id=item.asset.id) }}">{{ item.asset.name }}</a></td>
            <td>{{ item.asset.location or '—' }}</td>
            <td>{{ item.event_label }}</td>
            <td>
              <a href="{{ request.url_for('asset_detail', asset_id=item.asset.id) }}" class="btn btn-sm btn-outline-primary" title="Открыть">↗</a>
              <a href="{{ request.url_for('asset_edit', asset_id=item.asset.id) }}" class="btn btn-sm btn-outline-secondary" title="Изменить">✎</a>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="text-muted text-center py-4">Нет устройств, требующих внимания</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="d-flex flex-wrap gap-2 mt-3">
  <a href="{{ request.url_for('asset_create') }}" class="btn btn-primary btn-sm">+ Добавить оборудование</a>
  <a href="{{ request.url_for('reports') }}" class="btn btn-primary btn-sm">Сформировать отчёт</a>
  <a href="{{ request.url_for('assets_export') }}" class="btn btn-primary btn-sm">Экспорт в Excel</a>
  <a href="{{ request.url_for('assets_list') }}?inactive_by_activity=1" class="btn btn-primary btn-sm">Просмотр неактивных</a>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function() {
  var statusData = {
    labels: ['Активные', 'Неактивные', 'Списано'],
    datasets: [{
      data: [{{ chart_status.active }}, {{ chart_status.inactive }}, {{ chart_status.retired }}],
      backgroundColor: ['#198754', '#dc3545', '#fd7e14']
    }]
  };
  var statusCtx = document.getElementById('chartStatus');
  if (statusCtx) {
    new Chart(statusCtx, {
      type: 'pie',
      data: statusData,
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2,
        plugins: { legend: { display: false } }
      }
    });
  }
  var inactData = {
    labels: ['До 7 дней', 'Неделя–месяц', 'Более месяца'],
    datasets: [{
      data: [{{ chart_inactivity['0_7'] }}, {{ chart_inactivity['7_30'] }}, {{ chart_inactivity['30_plus'] }}],
      backgroundColor: ['#ffc107', '#fd7e14', '#0d6efd']
    }]
  };
  var inactCtx = document.getElementById('chartInactivity');
  if (inactCtx) {
    new Chart(inactCtx, {
      type: 'doughnut',
      data: inactData,
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2,
        plugins: { legend: { display: false } }
      }
    });
  }
})();
</script>
{% endblock %}
